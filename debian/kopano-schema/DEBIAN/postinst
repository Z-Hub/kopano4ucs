#!/bin/sh
# postinst script for kopano-schema
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package


# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.




. /usr/share/univention-lib/all.sh

ucs_registerLDAPSchema /usr/share/kopano-schema/kopano4ucs.schema

# from univention-ldap-server.postinst
merge_csv_unique_sorted() {
   if [ "$1" = "none" ]; then
      local old=
   else
      local old="$1"
   fi
   echo "$old,$2" | tr ',' '\n' | sort -u | tr '\n' ',' | sed -re 's/^,|(,){2,}|,$/\1/g'
}

if is_ucr_true "ldap/index/autorebuild" ; then
   # register kopano attributes
   kopano_attributes="kopanoAccount,kopanoAliases,kopanoViewPrivilege"
   merged_ldap_index_eq="$(merge_csv_unique_sorted "$(ucr get ldap/index/eq)" "$kopano_attributes")"
   ucr set ldap/index/eq="$merged_ldap_index_eq"

   invoke-rc.d slapd stop
   { /usr/sbin/slapindex  2>&1 >&3 | sed -e "/Runnig as root\!/,/There's a fair chance slapd will fail to start./d" >&2; } 3>&1
   invoke-rc.d slapd start
fi 

exit 0
